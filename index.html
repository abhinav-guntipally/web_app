<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Document Analyzer</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for client-side PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        /* A little custom CSS for flair */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Header Section -->
        <header class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800">LLM Document Analyzer</h1>
            <p class="text-gray-600 mt-2">Upload a business document (PDF) to classify it and find missing information.</p>
        </header>

        <!-- Main Application Section -->
        <main class="bg-white rounded-lg shadow-md p-6">

            <!-- 1. Upload Section -->
            <div id="upload-section">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Step 1: Upload Document</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <input type="file" id="pdf-upload" accept=".pdf" class="hidden">
                    <button id="upload-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Select PDF File
                    </button>
                    <p id="file-name" class="mt-4 text-gray-500">No file selected.</p>
                </div>
            </div>
            
            <!-- Analyze Button -->
            <div class="mt-6 text-center">
                <button id="analyze-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Analyze Document
                </button>
            </div>

            <!-- 2. Loading & Results Section -->
            <div id="analysis-section" class="mt-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Step 2: Analysis Results</h2>
                
                <!-- Loader -->
                <div id="loader" class="flex flex-col items-center justify-center p-8">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600">Analyzing document... This may take a moment.</p>
                </div>
                
                <!-- Error Message -->
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline" id="error-text"></span>
                </div>

                <!-- Results Display -->
                <div id="results-display" class="hidden space-y-6">
                    <!-- Document Type -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Document Type</h3>
                        <p id="doc-type" class="text-2xl font-bold text-blue-600 mt-1"></p>
                    </div>

                    <!-- Missing Fields -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Missing Information</h3>
                        <div id="missing-fields" class="mt-2">
                            <!-- Content will be generated by JavaScript -->
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Recommendations</h3>
                        <p id="recommendations" class="text-gray-700 bg-gray-50 p-4 rounded-lg border"></p>
                    </div>

                </div>
            </div>

             <!-- Extracted Text (for debugging/verification) -->
            <div id="text-content-section" class="mt-8 hidden">
                 <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Extracted Text</h2>
                 <pre id="text-content" class="bg-gray-900 text-white p-4 rounded-md text-sm whitespace-pre-wrap max-h-96 overflow-y-auto"></pre>
            </div>

        </main>

    </div>

    <script type="module">
        // DOM Element References
        const uploadButton = document.getElementById('upload-button');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisSection = document.getElementById('analysis-section');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const resultsDisplay = document.getElementById('results-display');
        const docTypeDisplay = document.getElementById('doc-type');
        const missingFieldsDisplay = document.getElementById('missing-fields');
        const recommendationsDisplay = document.getElementById('recommendations');
        const textContentSection = document.getElementById('text-content-section');
        const textContentDisplay = document.getElementById('text-content');

        let uploadedFile = null;

        // --- Step 1: File Upload Handling ---
        
        // Trigger file input when the custom button is clicked
        uploadButton.addEventListener('click', () => {
            pdfUploadInput.click();
        });

        // Handle file selection
        pdfUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                uploadedFile = file;
                fileNameDisplay.textContent = file.name;
                fileNameDisplay.classList.remove('text-red-500');
                analyzeBtn.disabled = false;
            } else {
                uploadedFile = null;
                fileNameDisplay.textContent = 'Invalid file. Please select a PDF.';
                fileNameDisplay.classList.add('text-red-500');
                analyzeBtn.disabled = true;
            }
        });

        // --- Step 2: Analysis Process ---

        analyzeBtn.addEventListener('click', async () => {
            if (!uploadedFile) {
                showError('No file selected.');
                return;
            }

            // Show the analysis section and loader
            analysisSection.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultsDisplay.classList.add('hidden');
            errorMessage.classList.add('hidden');
            textContentSection.classList.add('hidden');
            
            try {
                // Extract text from the PDF
                const extractedText = await extractPdfText(uploadedFile);
                textContentDisplay.textContent = extractedText;
                // Optional: Show the extracted text for debugging
                // textContentSection.classList.remove('hidden');

                if (!extractedText.trim()) {
                   throw new Error("Could not extract any text from the PDF. It might be an image-based PDF.");
                }

                // Call the LLM for analysis
                const analysisResult = await analyzeDocumentWithLLM(extractedText);
                
                // Display the results
                displayResults(analysisResult);

            } catch (err) {
                showError(err.message || 'An unknown error occurred.');
            } finally {
                // Hide loader regardless of outcome
                loader.classList.add('hidden');
            }
        });

        /**
         * Extracts text content from a PDF file using PDF.js.
         * @param {File} file - The PDF file object.
         * @returns {Promise<string>} A promise that resolves with the extracted text.
         */
        async function extractPdfText(file) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n\n';
            }
            return fullText;
        }

        /**
         * Sends the document text to the Gemini API for analysis.
         * @param {string} text - The extracted text from the document.
         * @returns {Promise<object>} A promise that resolves with the parsed JSON analysis from the LLM.
         */
        async function analyzeDocumentWithLLM(text) {
            // NOTE: In a real app, you'd use your actual API key.
            // In this environment, the key is handled automatically.
            const apiKey = "AIzaSyC3YTN2qou1S3nQLYW9tKibpYTAB9YUtTs"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = `You are an expert document analyzer for a business. Your task is to classify a document and identify any missing critical information based on predefined requirements.

            Required fields are:
            - For a 'Contract': party_1, party_2, signature, date, payment_terms
            - For an 'Invoice': invoice_number, amount, due_date, tax, bill_to, bill_from

            Analyze the provided document text and respond ONLY with a valid JSON object. Do not include any other text or markdown formatting.

            The JSON object must have the following structure:
            {
              "documentType": "Contract" | "Invoice" | "Other",
              "confidence": "High" | "Medium" | "Low",
              "missingFields": ["field1", "field2", ...],
              "recommendations": "A concise, actionable checklist for improvement."
            }
            `;
            
            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: `Here is the document text:\n\n${text}` }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorBody}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
                throw new Error("Received an invalid or empty response from the AI model.");
            }

            try {
                return JSON.parse(jsonText);
            } catch (e) {
                console.error("Failed to parse JSON response from LLM:", jsonText);
                throw new Error("The AI model returned a response that was not valid JSON.");
            }
        }
        
        /**
         * Renders the analysis results on the page.
         * @param {object} data - The analysis data object from the LLM.
         */
        function displayResults(data) {
            docTypeDisplay.textContent = `${data.documentType} (Confidence: ${data.confidence})`;

            // Clear previous results
            missingFieldsDisplay.innerHTML = ''; 

            if (data.missingFields && data.missingFields.length > 0) {
                 const list = document.createElement('ul');
                 list.className = 'list-disc list-inside space-y-2';
                 data.missingFields.forEach(field => {
                    const item = document.createElement('li');
                    item.className = 'bg-yellow-100 text-yellow-800 p-2 rounded-md';
                    item.innerHTML = `<strong>${field.replace(/_/g, ' ')}:</strong> This critical field appears to be missing.`;
                    list.appendChild(item);
                 });
                 missingFieldsDisplay.appendChild(list);
            } else {
                 missingFieldsDisplay.innerHTML = `<p class="bg-green-100 text-green-800 p-3 rounded-md">✅ All required fields appear to be present!</p>`;
            }

            recommendationsDisplay.textContent = data.recommendations;
            resultsDisplay.classList.remove('hidden');
        }

        /**
         * Displays an error message in the UI.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            resultsDisplay.classList.add('hidden');
        }

    </script>
</body>
</html>
